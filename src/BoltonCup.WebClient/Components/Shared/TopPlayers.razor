@using System.Linq.Expressions
@using BoltonCup.Sdk
@namespace BoltonCup.WebClient.Components.Shared
@typeparam T
@inject IBoltonCupApi BoltonCupApi
@inject NavigationManager Navigation



@if (_skaterCategoryFunc is not null)
{
    <MudList T="SkaterStatDetailDto" @bind-SelectedValue="_selectedSkater" Color="Color.Primary" Style="width: 100%; height: 100%" Dense>
        <MudListSubheader>
            <a class="d-flex flex-row align-center justify-space-between" href="@SelectedSkaterHref">
                @if (_selectedSkater is not null)
                {
                    <div class="d-flex flex-row align-center gap-3">
                        <MudAvatar Size="Size.Large">
                            <MudImage Src="@_selectedSkater.ProfilePicture" Alt="@_selectedSkater.FullName" Height="80" Width="80"/>
                        </MudAvatar>
                        <div class="d-flex flex-column align-start justify-space-evenly">
                            <MudText Typo="Typo.subtitle2" Color="Color.Info"><b>@Label</b></MudText>
                            <MudText Typo="Typo.subtitle2" Color="Color.Primary">@_selectedSkater.FullName</MudText>
                            <div class="d-flex flex-row align-center gap-1">
                                <MudImage Src="@_selectedSkater.TeamLogoUrl" Alt="@_selectedSkater.TeamName" Width="20" Height="20"/>
                                <MudText Typo="Typo.caption">@_selectedSkater.Position.ToUpper().First()</MudText>
                                <MudText Typo="Typo.caption">@($"#{_selectedSkater.JerseyNumber.ToString() ?? string.Empty}")</MudText>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex flex-column align-center justify-space-evenly">
                        <MudText Typo="Typo.h6" Color="Color.Primary">@_skaterCategoryFunc(_selectedSkater)</MudText>
                        <MudText Typo="Typo.caption">@Label?.ToUpper()</MudText>
                    </div>
                }
            </a>
        </MudListSubheader>
        @foreach (var (i, skater) in _skaterStats.Index())
        {
            <MudListItem Value="skater" @onmouseover="@(() => _selectedSkater = skater)">
                <div class="d-flex flex-row align-center justify-space-between">
                    <MudText><MudText Typo="Typo.caption" Inline>@(i + 1).</MudText> @skater.FullName</MudText>
                    <MudText>@_skaterCategoryFunc(skater)</MudText>
                </div>
            </MudListItem>
        }
    </MudList>
}
else if (_goalieCategoryFunc is not null)
{
    <MudList T="GoalieStatDetailDto" @bind-SelectedValue="_selectedGoalie" Color="Color.Primary" Style="width: 100%; height: 100%" Dense>
        <MudListSubheader>
            <a class="d-flex flex-row align-center justify-space-between" href="@SelectedGoalieHref">
                @if (_selectedGoalie is not null)
                {
                    <div class="d-flex flex-row align-center gap-3">
                        <MudAvatar Size="Size.Large">
                            <MudImage Src="@_selectedGoalie.ProfilePicture" Alt="@_selectedGoalie.FullName" Height="40" Width="40" />
                        </MudAvatar>
                        <div class="d-flex flex-column align-start justify-space-evenly">
                            <MudText Typo="Typo.subtitle2" Color="Color.Info"><b>@Label</b></MudText>
                            <MudText Typo="Typo.subtitle2" Color="Color.Primary">@_selectedGoalie.FullName</MudText>
                            <div class="d-flex flex-row align-center gap-1">
                                <MudImage Src="@_selectedGoalie.TeamLogoUrl" Alt="@_selectedGoalie.TeamName" Width="20" Height="20" />
                                <MudText Typo="Typo.caption">@_selectedGoalie.Position.ToUpper().First()</MudText>
                                <MudText Typo="Typo.caption">@($"#{_selectedGoalie.JerseyNumber.ToString() ?? string.Empty}")</MudText>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex flex-column align-center justify-space-evenly">
                        <MudText Typo="Typo.h6" Color="Color.Primary">@_goalieCategoryFunc(_selectedGoalie)</MudText>
                        <MudText Typo="Typo.caption">@Label?.ToUpper()</MudText>
                    </div>
                }
            </a>
        </MudListSubheader>
        @foreach (var (i, goalie) in _goalieStats.Index())
        {
            <MudListItem Value="goalie" @onmouseover="@(() => _selectedGoalie = goalie)">
                <div class="d-flex flex-row align-center justify-space-between">
                    <MudText><MudText Typo="Typo.caption" Inline>@(i + 1).</MudText> @goalie.FullName</MudText>
                    <MudText>@_goalieCategoryFunc(goalie)</MudText>
                </div>
            </MudListItem>
        }
    </MudList>
}

@code {
    
    [Parameter]
    public string? Label { get; set; }
    
    [Parameter]
    public int? TournamentId { get; set; }

    [Parameter]
    public int Players { get; set; } = 5;
    
    [Parameter]
    public bool Descending { get; set; }

    [Parameter]
    public Expression<Func<SkaterStatDetailDto, T>>? SkaterCategory { get; set; }
    
    [Parameter]
    public Expression<Func<GoalieStatDetailDto, T>>? GoalieCategory { get; set; }

    private Expression<Func<SkaterStatDetailDto, T>>? _skaterCategory;
    private Expression<Func<GoalieStatDetailDto, T>>? _goalieCategory;
    
    private Func<SkaterStatDetailDto, T>? _skaterCategoryFunc;
    private Func<GoalieStatDetailDto, T>? _goalieCategoryFunc;

    private List<SkaterStatDetailDto> _skaterStats = [];
    private List<GoalieStatDetailDto> _goalieStats = [];

    private SkaterStatDetailDto? _selectedSkater;
    private GoalieStatDetailDto? _selectedGoalie;
    
    private string SelectedSkaterHref => _selectedSkater is not null 
        ? $"/players/{_selectedSkater.PlayerId}"
        : "/";
    private string SelectedGoalieHref => _selectedGoalie is not null
        ? $"/players/{_selectedGoalie.PlayerId}"
        : "/";
    
    protected override Task OnParametersSetAsync()
    {
        if (SkaterCategory is not null)
            return OnSkaterParametersSetAsync();
        if (GoalieCategory is not null)
            return OnGoalieParametersSetAsync();
        return Task.CompletedTask;
    }
    
    private async Task OnSkaterParametersSetAsync()
    {
        if (_skaterCategory == SkaterCategory)
            return;
        _skaterCategory = SkaterCategory;
        if (_skaterCategory is null)
            return;
        _skaterCategoryFunc = _skaterCategory.Compile();

        var sortBy = GetExpressionPropertyName(_skaterCategory);
        var data = await BoltonCupApi.GetSkaterStatsAsync(
            tournamentId: TournamentId,
            size: Players,
            sortBy: sortBy,
            descending: Descending
        );
        _skaterStats = data.Items.ToList();
        _selectedSkater = _skaterStats.FirstOrDefault();
        await InvokeAsync(StateHasChanged);
    }
    
    private async Task OnGoalieParametersSetAsync()
    {
        if (_goalieCategory == GoalieCategory)
            return;
        _goalieCategory = GoalieCategory;
        if (_goalieCategory is null)
            return;
        _goalieCategoryFunc = _goalieCategory.Compile();
        
        var sortBy = GetExpressionPropertyName(_goalieCategory);
        var data = await BoltonCupApi.GetGoalieStatsAsync(
            tournamentId: TournamentId,
            size: Players,
            sortBy: sortBy,
            descending: Descending
        );
        _goalieStats = data.Items.ToList();
        _selectedGoalie = _goalieStats.FirstOrDefault();
        await InvokeAsync(StateHasChanged);
    }

    private void NavToSelectedSkater()
    {
        if (_selectedSkater is not null)
            Navigation.NavigateTo($"/player/{_selectedSkater.PlayerId}");
    }
    
    private void NavToSelectedGoalie()
    {
        if (_selectedGoalie is not null)
            Navigation.NavigateTo($"/player/{_selectedGoalie.PlayerId}");
    }

    
    private static string GetExpressionPropertyName<TSource>(Expression<Func<TSource, T>> expression)
    {
        if (expression == null)
            throw new ArgumentNullException(nameof(expression));
        var memberExpression = (MemberExpression)(
            expression.Body is UnaryExpression ue 
                ? ue.Operand
                : expression.Body
        );
        return memberExpression.Member.Name;
    }
}