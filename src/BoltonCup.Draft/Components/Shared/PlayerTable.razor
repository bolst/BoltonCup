@implements IDisposable

@inject IBCData BCData
@inject Data.DraftServiceProvider Drafter
@inject IDialogService DialogService
@inject HubConnectionProvider Hub
@inject Supabase.Client SBClient

@if (_players is not null)
{
    <MudDataGrid
        T="PlayerProfile"
        Items="_filteredPlayers"
        Height="calc(90vh - 4rem)"
        QuickFilter="QuickFilter"
        RowStyleFunc="RowStyleFunc"
        ShowColumnOptions="false"
        FixedHeader
        Dense>
        <ToolBarContent>
            <AuthorizeView Roles="admin">
                <MudMenu
                    Label="Actions"
                    Variant="Variant.Filled"
                    EndIcon="@Icons.Material.Filled.KeyboardArrowDown"
                    IconColor="Color.Error"
                    Dense>
                    <MudMenuItem >
                        <DraftControlButton FullWidth />
                    </MudMenuItem>
                    <MudMenuItem>
                        <MudButton Color="Color.Error" OnClick="OnResetDraft" FullWidth>Reset</MudButton>
                    </MudMenuItem>
                </MudMenu>
            </AuthorizeView>

            <MudChipSet T="string" Variant="Variant.Text" SelectedValue="_positionFilter" SelectedValueChanged="PositionFilterChanged" SelectionMode="SelectionMode.ToggleSelection">
                <MudChip Text="F" Color="Color.Primary" Value="@("forward")"/>
                <MudChip Text="D" Color="Color.Secondary" Value="@("defense")"/>
                <MudChip Text="G" Color="Color.Warning" Value="@("goalie")"/>
            </MudChipSet>
            
            <MudSwitch T="bool" 
                       Value="_availabilityView" 
                       ValueChanged="OnAvailabilityViewSwitchChanged"
                       ThumbIcon="@(_availabilityView ? Icons.Material.Filled.EventAvailable : Icons.Material.Filled.QueryStats)"
                       ThumbIconColor="@(_availabilityView ? Color.Secondary : Color.Primary)"
                       Disabled="_loading" />

            <MudSpacer/>
            <MudTextField @bind-Value="_searchString" Placeholder="Search" Adornment="Adornment.Start" Immediate="true"
                          AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"/>
        </ToolBarContent>

        <Columns>
            <TemplateColumn>
                <CellTemplate>
                    <AuthorizeView Roles="captain,admin" Context="authContext">
                        @{
                            var disabled = authContext.User.IsInRole("admin") ? Disabled : !UserCanPick;
                        }
                        <MudButton
                            Color="Color.Default"
                            Variant="Variant.Filled"
                            OnClick="@(() => OnPlayerDrafted(context.Item))"
                            Disabled="disabled">DRAFT</MudButton>
                    </AuthorizeView>
                </CellTemplate>
            </TemplateColumn>
            <PropertyColumn Property="x => x.name" Title="Name" CellStyle="font-weight: bold" />
            <PropertyColumn Property="x => x.position" Title="Pos." Hidden="_availabilityView">
                <CellTemplate>
                    <PositionChip Position="@context.Item.position" Size="Size.Small" />
                </CellTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.HighestLevel" Title="Highest Level" SortBy="SortByHighestLevel" Hidden="_availabilityView" />
            <PropertyColumn Property="@(x => x.dob.ToString("yyyy"))" Title="Birth year" Hidden="_availabilityView" />
            @* <PropertyColumn Property="@(x => x.Availabilities.Count(y => y.Value == "out"))" Title="Games Missing" Hidden="_availabilityView" /> *@
            
            
            <PropertyColumn Property="x => x.Availabilities" Title="Availability" Hidden="!_availabilityView">
                <CellTemplate>
                    <MudStack AlignItems="AlignItems.Center" Wrap="Wrap.Wrap" Spacing="0" Row>
                        @if (context.Item.Availabilities.Any(a => a.Value != "null"))
                        {
                            foreach (var availability in context.Item.Availabilities.Where(a => a.Value != "null"))
                            {
                                var isIn = availability.Value == "in";
                                <MudChip Color="Color.Surface" Icon="@(isIn ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Cancel)" IconColor="@(isIn ? Color.Success : Color.Error)" Variant="Variant.Filled" Size="Size.Small">@availability.Key.ToString("ddd. h:mm")</MudChip>
                            }
                        }
                        else
                        {
                            <MudText>Not set</MudText>
                        }
                    </MudStack>
                </CellTemplate>
            </PropertyColumn>
        </Columns>
    </MudDataGrid>
}

<MudOverlay @bind-Visible="_loading" DarkBackground Absolute>
    <MudProgressCircular Indeterminate />
</MudOverlay>


@code {
    
    [Parameter]
    public bool Disabled { get; set; }
    
    private IEnumerable<IDisposable> _hubEvents = [];

    private IEnumerable<PlayerProfile>? _players;
    private HashSet<PlayerProfile> _filteredPlayers = new();
    private BCTournament? _currentTournament;
    private BCTeam? _currentTeam;
    private IEnumerable<BCAccount> _currentRoster = [];

    private string _searchString;
    private string _positionFilter;
    private bool _loading;
    private bool _availabilityView;
    
    private BCAccount? _currentUser;
    
    private bool UserCanPick => _currentUser is not null && (_currentTeam?.gm_account_id == _currentUser.id) 
                                                         && !Disabled;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
        await InitializeHubConnection();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        var user = SBClient.Auth.CurrentUser;
        if (user?.Email is not null)
        {
            _currentUser = await BCData.GetAccountByEmailAsync(user.Email);
        }
    }

    private async Task LoadDataAsync()
    {
        _loading = true;
        await InvokeAsync(StateHasChanged);
        
        (_currentTeam, _) = await Drafter.GetTeamWithCurrentPick();
        _currentRoster = await BCData.GetAccountsByTeamIdAsync(_currentTeam.id);
        _currentTournament = await BCData.GetCurrentTournamentAsync();
        if (_currentTournament is not null)
        {
            _players = (await BCData.GetDraftAvailableTournamentPlayersAsync(_currentTournament.tournament_id)).OrderBy(SortByHighestLevel);
            _filteredPlayers = new(_players);
        }
        
        _loading = false;
        await InvokeAsync(StateHasChanged);
    }


    private async Task OnAvailabilityViewSwitchChanged(bool value)
    {
        _loading = true;
        await InvokeAsync(StateHasChanged);
        
        _availabilityView = value;

        _loading = false;
        await InvokeAsync(StateHasChanged);
    }
    
    private async Task OnResetDraft()
    {
        await Drafter.ResetDraftAsync();
        await LoadDataAsync();
    }

    private async Task OnPlayerDrafted(PlayerProfile player)
    {
        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.False,
            FullWidth = false,
        };
        var parameters = new DialogParameters<DraftPlayerDialog>
        {
            { x => x.Player, player },
        };
        
        var dialog = await DialogService.ShowAsync<DraftPlayerDialog>("Draft Player", parameters, options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
        {
            _loading = true;
            await InvokeAsync(StateHasChanged);
            
            await Drafter.DraftPlayerAsync(player);
            //await LoadDataAsync();
        }
    }
    
    private Func<PlayerProfile, bool> QuickFilter => x =>
    {
        if (string.IsNullOrWhiteSpace(_searchString))
            return true;

        if (x.name.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        return false;
    };

    private void PositionFilterChanged(string? position)
    {
        if (_players is null) return;

        if (string.IsNullOrEmpty(position))
        {
            _filteredPlayers = new(_players);
        }
        else
        {
            _filteredPlayers = new(_players.Where(p => p.position == position));
        }
    }

    private Func<PlayerProfile, object> SortByHighestLevel => x =>
    {
        return x.HighestLevel switch
        {
            "Jr. A or higher" => 0,
            "Jr. B" => 1,
            "Jr. C" => 2,
            "AAA" => 3,
            "A/AA" => 4,
            "House league" => 5,
            _ => 1000
        };
    };
    
    private async Task InitializeHubConnection()
    {
        var connection = await Hub.GetHubConnection();
        
        var c1 = connection.On(DraftHub.Events.OnDraftUpdate, async () =>
        {
            await LoadDataAsync();
            
            InvokeAsync(StateHasChanged);
        });

        _hubEvents = _hubEvents.Append(c1);
    }

    private string RowStyleFunc(PlayerProfile player, int row)
    {
        if (_currentRoster.Any(x => x.preferred_teammate1 == player.account_id || x.preferred_teammate2 == player.account_id))
        {
            return "background-color: var(--mud-palette-tertiary);";
        }

        return string.Empty;
    }

    
    public void Dispose()
    {
        foreach (var hubEvent in _hubEvents)
        {
            hubEvent.Dispose();
        }
        _hubEvents = [];
    }
}