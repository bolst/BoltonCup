@inherits HubComponentBase

@inject Data.DraftServiceProvider Drafter
@inject IBCData _bcData

@if (_draft is not null)
{
    if (_draft.State.EqualsEnum(DraftState.Live))
    {
        <MudButton OnClick="EndDraft" Color="Color.Error" FullWidth="FullWidth">End Draft</MudButton>
    }
    else if (_draft.State.EqualsEnum(DraftState.Inactive))
    {
        <MudButton OnClick="BeginDraft" Color="Color.Info" FullWidth="FullWidth">Start Draft</MudButton>
    }
}

@code {

    [Parameter]
    public bool FullWidth { get; set; }

    private BCDraft? _draft;
    
    protected override async Task OnInitializedAsync()
    {
        _draft = await Drafter.GetDraftAsync();
        await base.OnInitializedAsync();
    }

    
    public async Task BeginDraft()
    {
        if (_draft is null) return;
        
        await _bcData.UpdateDraftStateAsync(_draft.Id, DraftState.Live);
        await Hub.SendAsync(nameof(DraftHub.PushDraftStateChange));
    }

    public async Task EndDraft()
    {
        if (_draft is null) return;
        
        await _bcData.UpdateDraftStateAsync(_draft.Id, DraftState.Inactive);
        await Hub.SendAsync(nameof(DraftHub.PushDraftStateChange));
    }
    
    
    protected override void AddHubHandlers()
    {
        Hub.On(DraftHub.Events.OnDraftUpdate, async () =>
        {
            Drafter.InvalidateDraftCache();
            _draft = await Drafter.GetDraftAsync();
            await InvokeAsync(StateHasChanged);
        });
    }

}