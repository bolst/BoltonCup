@page "/log-in-or-sign-up"
@inject IBoltonCupApi BoltonCupApi
@inject NavigationManager Navigation
@inject AuthSessionStateService AuthSessionState

<PageTitle>Log in or sign up | Bolton Cup</PageTitle>

<MudText Typo="Typo.h4">Log in or sign up</MudText>

<AutoEditForm T="LogInOrSignUpForm" EditContext="_editContext" OnValidSubmit="OnSubmit" />

@code {
    
    [SupplyParameterFromQuery]
    public string? ReturnUrl { get; set; }

    private readonly LogInOrSignUpForm _model = new();
    private EditContext? _editContext;

    protected override void OnInitialized() 
    {
        _model.Email = AuthSessionState.Email ?? string.Empty;
        _editContext = new EditContext(_model);
    }

    private async Task OnSubmit(EditContext context)
    {
        AuthSessionState.Initialize(_model.Email);
        
        try
        {
            var user = await BoltonCupApi.GetUserAsync(_model.Email);
            if (string.IsNullOrEmpty(user?.Email))
            {
                Navigation.NavigateTo($"/create-account/password?returnUrl={ReturnUrl}");
                return;
            }
            
            Navigation.NavigateTo($"log-in/password?returnUrl={ReturnUrl}");
        }
        catch (ApiException e)
            when (e.StatusCode is 204 or 404)
        {
            Navigation.NavigateTo($"/create-account/password?returnUrl={ReturnUrl}");
        }
    }

}