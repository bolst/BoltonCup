@page "/log-in/password"
@implements IDisposable
@inject AuthSessionStateService AuthSessionState
@inject NavigationManager Navigation
@inject IBoltonCupApi BoltonCupApi
@inject ISnackbar Snackbar
@inject IOptions<Common.BoltonCupConfiguration> Config

<AuthSession>
    <AutoEditForm T="LogInWithPasswordForm" EditContext="_editContext" OnValidSubmit="OnSubmit" Title="Enter your password" />
</AuthSession>


@code {
    
    [SupplyParameterFromQuery]
    private string? ReturnUrl { get; set; } 
    
    private readonly LogInWithPasswordForm _model = new();
    private EditContext? _editContext;
    private ValidationMessageStore? _messageStore;


    protected override void OnInitialized() 
    {
        _model.Email = AuthSessionState.Email ?? string.Empty;

        _editContext = new EditContext(_model);
        _editContext.OnValidationRequested += HandleValidationRequested;
        _messageStore = new ValidationMessageStore(_editContext);
    }
    
    private void HandleValidationRequested(object? sender, ValidationRequestedEventArgs args)
    {
        _messageStore?.Clear();
    }

    private async Task OnSubmit(EditContext context)
    {
        var delayTask = Task.Delay(3000); // load for 3 seconds minimum
        try
        {
            var loginTask = BoltonCupApi.LoginWithCookieAsync(new LoginWithCookieRequest
            {
                Email = _model.Email,
                Password = _model.Password
            });
            await Task.WhenAll(delayTask, loginTask);
            Navigation.NavigateTo(ReturnUrl ?? Config.Value.WebBaseUrl, true);
        }
        catch (ApiException e)
            when (e.StatusCode == 401)
        {
            _messageStore?.Add(() => _model.Password, "Invalid password.");
            _editContext?.NotifyValidationStateChanged();
        }        
        catch (ApiException e)
            when (e.StatusCode == 429)
        {
            _messageStore?.Add(() => _model.Password, "You made too many requests! Try again later.");
            _editContext?.NotifyValidationStateChanged();
        }
        catch (Exception e)
        {
            Snackbar.Add("An unexpected error occurred.", Severity.Error);
        }
    }
    
    public void Dispose()
    {
        if (_editContext != null)
        {
            _editContext.OnValidationRequested -= HandleValidationRequested;
        }
    }

}