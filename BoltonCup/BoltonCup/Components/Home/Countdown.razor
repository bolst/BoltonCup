@namespace BoltonCup.Components
@using System.Timers


@if (TimeUntil != null)
{
    <Grid RowColumns="RowColumns.Are4.OnTablet.Are3.OnMobile" Padding="Padding.Is4.OnY"
        TextAlignment="TextAlignment.Center">
        <Column ColumnSize="ColumnSize.Is3.OnTablet.Is12.OnMobile">
            @TimeUnitComponent(TimeUntil?.Days ?? 0, "DAYS")
        </Column>
        <Column ColumnSize="ColumnSize.Is3.OnTablet.Is4.OnMobile">
            @TimeUnitComponent(TimeUntil?.Hours ?? 0, "HOURS")
        </Column>
        <Column ColumnSize="ColumnSize.Is3.OnTablet.Is4.OnMobile">
            @TimeUnitComponent(TimeUntil?.Minutes ?? 0, "MINUTES")
        </Column>
        <Column ColumnSize="ColumnSize.Is3.OnTablet.Is4.OnMobile">
            @TimeUnitComponent(TimeUntil?.Seconds ?? 0, "SECONDS")
        </Column>
    </Grid>
}


@code {

    RenderFragment TimeUnitComponent(int value, string label) => __builder =>
    {
        <DisplayHeading Size="DisplayHeadingSize.Is1" TextColor="TextColor.Secondary" Italic>@value
        </DisplayHeading>
        <Heading TextSize="TextSize.Small" TextColor="TextColor.Secondary">@label</Heading>
    };

    static Timer myTimer;
    DateTime TournamentStart = new DateTime(2024, 08, 02, 5 + 12, 30, 00); // august 2 5:30pm
    TimeSpan? TimeUntil = null;
    TimeSpan dt = new TimeSpan(0, 0, 1);

    protected override void OnInitialized()
    {
        var timeUtc = DateTime.UtcNow;
        TimeZoneInfo est = TimeZoneInfo.FindSystemTimeZoneById("Eastern Standard Time");
        DateTime estTimeNow = TimeZoneInfo.ConvertTimeFromUtc(timeUtc, est);
        TimeUntil = TournamentStart - estTimeNow;
        StartTimer();
    }
    void StartTimer()
    {
        myTimer = new Timer(1000);
        myTimer.Elapsed += CountDownTimer;
        myTimer.Enabled = true;
    }

    public void CountDownTimer(Object source, ElapsedEventArgs e)
    {
        if (TimeUntil != null)
        {
            TimeUntil = TimeUntil?.Subtract(dt);
        }
        else
        {
            myTimer.Enabled = false;
        }
        InvokeAsync(StateHasChanged);
    }
}
